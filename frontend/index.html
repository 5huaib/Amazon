<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amazon Rides - Live Tracking</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        
        .fade-in-up {
            animation: fadeInUp 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-white">

    <div class="flex flex-wrap min-h-screen">
        <!-- Left Panel: Form & Info -->
        <div class="w-full md:w-1/2 lg:w-1/3 flex flex-col justify-center p-8 lg:p-12">
            <div class="w-full max-w-md mx-auto">
                <!-- Header -->
                <div class="mb-8">
                    <!-- Styled Text Logo -->
                    <div class="h-12 mb-4 flex items-center">
                        <span class="text-4xl font-black text-gray-900 tracking-tight">Amazon</span>
                        <span class="text-4xl font-medium text-gray-500 ml-1">Rides</span>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900">Book Your Ride</h1>
                    <p class="text-gray-500 mt-2">Reliable and professional cab services.</p>
                </div>

                <!-- Form Container -->
                <div id="formContainer">
                    <form id="orderForm" class="space-y-4">
                        <div>
                            <label for="sourceLocation" class="block text-sm font-medium text-gray-700">Pick Up</label>
                            <div class="mt-1">
                                <input type="text" list="locations" id="sourceLocation" name="sourceLocation" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-400 focus:ring-yellow-400 sm:text-sm p-3" placeholder="Select a starting point" />
                            </div>
                            <button type="button" id="liveLocationBtn" class="group mt-2 flex items-center text-sm text-gray-600 hover:text-black font-medium">
                                <svg class="h-4 w-4 mr-1.5 text-gray-500 group-hover:text-black" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.42-.25.692-.455.272-.204.623-.478-1.022-.822.399-.344.822-.727-1.258-1.152.437-.424.847-.874 1.229-1.342a10.035 10.035 0 001.222-1.616.99.99 0 00.062-.215.99.99 0 00-.011-.223c-.023-.065-.05-.126-.08-.184a.99.99 0 00-.097-.192 10.075 10.075 0 00-1.616-1.222c-.468-.382-.918-.77-1.342-1.229-.425-.436-.808-.86-1.152-1.258-.344-.4-.618-.75-.822-1.022-.204-.272-.455-.506-.455-.692a5.741 5.741 0 00-.14-.282l-.008-.018-.003-.006-.001-.002C10.11 1.02 10 1 10 1s-.11.02-.308.066l-.002.001-.006.003-.018.008a5.741 5.741 0 00-.281.14c-.186.1-.42.25-.692-.455-.272.204-.623-.478-1.022-.822-.399-.344-.822-.727-1.258-1.152C5.556 3.35 5.146 3.8 4.719 4.228a10.035 10.035 0 00-1.222 1.616.99.99 0 00-.062.215.99.99 0 00.011.223c.023.065.05.126.08.184a.99.99 0 00.097-.192 10.075 10.075 0 001.616 1.222c.468.382.918-.77 1.342 1.229.425.436.808.86 1.152 1.258.344.4.618-.75.822 1.022.204-.272.455.506.455.692a5.741 5.741 0 00.14.282l.008.018.003.006.001.002zM10 8a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                                Use Current Location
                            </button>
                        </div>
                        <div>
                            <label for="destLocation" class="block text-sm font-medium text-gray-700">Drop Off</label>
                            <div class="mt-1">
                                <input type="text" list="locations" id="destLocation" name="destLocation" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-400 focus:ring-yellow-400 sm:text-sm p-3" placeholder="Select a destination" />
                            </div>
                        </div>
                        <div>
                            <label for="contactNo" class="block text-sm font-medium text-gray-700">Contact Number</label>
                             <div class="mt-1">
                                <input type="text" id="contactNo" name="contactNo" required pattern="[0-9]{10}" title="Please enter a 10-digit phone number" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-400 focus:ring-yellow-400 sm:text-sm p-3" placeholder="10-digit mobile number" />
                            </div>
                        </div>
                        
                        <datalist id="locations">
                            <option value="Koramangala"></option><option value="Indiranagar"></option><option value="Jayanagar"></option><option value="Whitefield"></option><option value="HSR Layout"></option><option value="Electronic City"></option><option value="Marathahalli"></option><option value="Bellandur"></option><option value="Hebbal"></option><option value="Yelahanka"></option><option value="Malleshwaram"></option><option value="Rajajinagar"></option><option value="Banashankari"></option><option value="Basavanagudi"></option><option value="MG Road"></option><option value="Ulsoor"></option><option value="Bannerghatta"></option><option value="JP Nagar"></option><option value="BTM Layout"></option><option value="Sarjapur Road"></option><option value="Richmond Town"></option><option value="Frazer Town"></option><option value="Yeshwanthpur"></option><option value="Kengeri"></option><option value="Vijayanagar"></option>
                        </datalist>

                        <button type="submit" id="submitBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-black bg-yellow-400 hover:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition-all duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
                            BOOK YOUR RIDE
                        </button>
                    </form>
                </div>
                
                <!-- Dynamic Panels -->
                <div id="driverDetails" class="mt-6 hidden fade-in-up">
                     <div class="bg-gray-50 p-5 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-bold mb-4 text-gray-800 text-center">Driver is on the way!</h3>
                        <div class="flex items-center space-x-4">
                            <img class="h-16 w-16 rounded-full object-cover" src="https://i.pravatar.cc/150?u=driver1" alt="Driver Avatar">
                            <div id="driverInfo" class="space-y-1 text-sm font-medium text-gray-600"></div>
                        </div>
                    </div>
                </div>
                
                <div id="arrivalInfo" class="mt-6 hidden fade-in-up">
                     <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 text-center">
                        <h3 id="arrivalMessage" class="text-lg font-bold text-green-600"></h3>
                        <p class="text-gray-500 text-sm mt-1">Share this OTP with your driver to start the trip.</p>
                        <div id="otpDisplay" class="mt-4 flex justify-center space-x-2 font-mono text-3xl font-bold text-gray-800 tracking-widest"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Image & Map -->
        <div class="w-full md:w-1/2 lg:w-2/3 bg-gray-900 relative">
            <div id="image-container" class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1552519507-da3b142c6e3d?q=80&w=2070&auto=format&fit=crop');">
                 <div class="absolute inset-0 bg-black opacity-40"></div>
            </div>
            <div id="map-container" class="absolute inset-0 hidden">
                <div id="map" class="w-full h-full"></div>
            </div>
        </div>
    </div>

    <script>
        const clientApiUrl = 'http://localhost:5001/api/client';
        const locationsCoords = { "Koramangala": {"lat": 12.9345, "lng": 77.6186}, "Indiranagar": {"lat": 12.9784, "lng": 77.6408}, "Jayanagar": {"lat": 12.9293, "lng": 77.5848}, "Whitefield": {"lat": 12.9699, "lng": 77.7508}, "HSR Layout": {"lat": 12.9116, "lng": 77.6385}, "Electronic City": {"lat": 12.8452, "lng": 77.6602}, "Marathahalli": {"lat": 12.9569, "lng": 77.7011}, "Bellandur": {"lat": 12.9304, "lng": 77.6784}, "Hebbal": {"lat": 13.0359, "lng": 77.5970}, "Yelahanka": {"lat": 13.1007, "lng": 77.5963}, "Malleshwaram": {"lat": 13.0068, "lng": 77.5703}, "Rajajinagar": {"lat": 12.9901, "lng": 77.5529}, "Banashankari": {"lat": 12.9252, "lng": 77.5469}, "Basavanagudi": {"lat": 12.9424, "lng": 77.5755}, "MG Road": {"lat": 12.9749, "lng": 77.6095}, "Ulsoor": {"lat": 12.9793, "lng": 77.6158}, "Bannerghatta": {"lat": 12.8016, "lng": 77.5771}, "JP Nagar": {"lat": 12.9073, "lng": 77.5784}, "BTM Layout": {"lat": 12.9166, "lng": 77.6101}, "Sarjapur Road": {"lat": 12.9121, "lng": 77.6749}, "Richmond Town": {"lat": 12.9610, "lng": 77.6018}, "Frazer Town": {"lat": 12.9965, "lng": 77.6139}, "Yeshwanthpur": {"lat": 13.0249, "lng": 77.5533}, "Kengeri": {"lat": 12.9174, "lng": 77.4837}, "Vijayanagar": {"lat": 12.9723, "lng": 77.5222} };
        const allowedLocations = Object.keys(locationsCoords);
        const form = document.getElementById('orderForm');
        const submitBtn = document.getElementById('submitBtn');
        const sourceLocationInput = document.getElementById('sourceLocation');
        const driverDetailsDiv = document.getElementById('driverDetails');
        const driverInfoDiv = document.getElementById('driverInfo');
        const arrivalInfoDiv = document.getElementById('arrivalInfo');
        const arrivalMessage = document.getElementById('arrivalMessage');
        const otpDisplay = document.getElementById('otpDisplay');
        const mapContainer = document.getElementById('map-container');
        const imageContainer = document.getElementById('image-container');
        const liveLocationBtn = document.getElementById('liveLocationBtn');
        let map, userMarker, driverMarker;
        let rideStatusInterval, liveUserCoords = null;
        const bangaloreCenter = [12.9716, 77.5946];
        const userIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41] });
        const driverIcon = L.icon({ iconUrl: 'https://em-content.zobj.net/source/apple/354/automobile_1f697.png', iconSize: [42, 42], iconAnchor: [21, 42] });

        function initMap() {
            if (map) { map.remove(); }
            map = L.map('map').setView(bangaloreCenter, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        liveLocationBtn.addEventListener('click', () => {
            if (!navigator.geolocation) return alert('Geolocation is not supported.');
            const originalText = liveLocationBtn.textContent;
            liveLocationBtn.textContent = 'Getting Location...';
            liveLocationBtn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    liveUserCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    sourceLocationInput.value = 'Current Location (Live)';
                    sourceLocationInput.classList.add('bg-yellow-100', 'border-yellow-400');
                    liveLocationBtn.textContent = originalText;
                    liveLocationBtn.disabled = false;
                },
                () => {
                    alert('Unable to retrieve your location.');
                    liveLocationBtn.textContent = originalText;
                    liveLocationBtn.disabled = false;
                }
            );
        });
        
        sourceLocationInput.addEventListener('input', () => {
            if (sourceLocationInput.value !== 'Current Location (Live)') {
                liveUserCoords = null;
                sourceLocationInput.classList.remove('bg-yellow-100', 'border-yellow-400');
            }
        });

        async function updateDriverLocation(driverId, orderId) {
            try {
                const response = await fetch(`${clientApiUrl}/drivers/location/${driverId}/${orderId}`);
                const result = await response.json();
                if (response.ok) {
                    const { latitude, longitude, status, otp } = result;
                    const driverCoords = [latitude, longitude];
                    if (driverMarker) driverMarker.setLatLng(driverCoords);
                    if (userMarker && map) {
                        map.panTo(driverCoords, { animate: true });
                    }
                    if (status === 'arrived') {
                        clearInterval(rideStatusInterval);
                        driverDetailsDiv.classList.add('hidden');
                        arrivalInfoDiv.classList.remove('hidden');
                        arrivalMessage.textContent = 'Your driver has arrived!';
                        otpDisplay.innerHTML = otp.split('').map(char => `<div class="w-10 h-14 flex items-center justify-center bg-gray-200 rounded-md">${char}</div>`).join('');
                    }
                } else { clearInterval(rideStatusInterval); }
            } catch (error) { clearInterval(rideStatusInterval); }
        }

        function startRideTracking(driverId, orderId) {
            rideStatusInterval = setInterval(() => { updateDriverLocation(driverId, orderId); }, 3000);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sourceLocation = sourceLocationInput.value;
            const destLocation = document.getElementById('destLocation').value;
            if (liveUserCoords === null && !allowedLocations.includes(sourceLocation)) return alert(`Invalid 'From' location.`);
            if (!allowedLocations.includes(destLocation)) return alert(`Invalid 'To' location.`);
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Searching...`;
            const userCoords = liveUserCoords || locationsCoords[sourceLocation];
            const requestData = { source_location: sourceLocation, dest_location: destLocation, contact_no: document.getElementById('contactNo').value, user_lat: userCoords.lat, user_lng: userCoords.lng };
            try {
                const response = await fetch(`${clientApiUrl}/ride-request`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                const result = await response.json();
                if (response.ok && result.success) {
                    const { order_id, driver_id, driver_details } = result.data;
                    
                    imageContainer.classList.add('hidden');
                    mapContainer.classList.remove('hidden');
                    form.classList.add('hidden');
                    driverDetailsDiv.classList.remove('hidden');
                    
                    initMap(); 

                    requestAnimationFrame(() => {
                        map.invalidateSize();
                        const userLatLng = [userCoords.lat, userCoords.lng];
                        const driverLatLng = driver_details.coords;
                        
                        userMarker = L.marker(userLatLng, { icon: userIcon }).addTo(map).bindPopup('Your Location');
                        driverMarker = L.marker(driverLatLng, { icon: driverIcon }).addTo(map).bindPopup('Driver Location');
                        
                        map.fitBounds([userLatLng, driverLatLng], { padding: [50, 50] });
                    });

                    driverInfoDiv.innerHTML = `<p><strong class="text-gray-800">Name:</strong> ${driver_details.name}</p><p><strong class="text-gray-800">ID:</strong> ${driver_details.driver_id}</p>`;
                    
                    startRideTracking(driver_id, order_id);

                } else { 
                    alert(`Error: ${result.message || 'Could not request ride.'}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'BOOK YOUR RIDE';
                }
            } catch (error) { 
                alert(`Network Error: ${error}.`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'BOOK YOUR RIDE';
            }
        });
        
        // Initialize map on page load so it's ready.
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>

